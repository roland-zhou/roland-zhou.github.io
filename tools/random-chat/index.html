<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Buddy - English Practice</title>
    <link rel="icon" href="random-chat.png" type="image/png">
    <link rel="apple-touch-icon" href="random-chat.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .typing-indicator span {
            animation: bounce 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        .sidebar-overlay {
            transition: opacity 0.3s ease;
        }
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 50;
            min-width: 150px;
        }
        .context-menu-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .context-menu-item:hover {
            background-color: #f3f4f6;
        }
        .context-menu-item.danger:hover {
            background-color: #fee2e2;
            color: #dc2626;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">
    <div class="flex h-screen">
        <!-- Sidebar Overlay (Mobile) -->
        <div id="sidebarOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 lg:hidden sidebar-overlay z-30"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-gray-900 text-white flex flex-col fixed lg:relative h-full lg:translate-x-0 -translate-x-full transition-transform duration-300 z-40 lg:z-0">
            <!-- Header -->
            <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                <h1 class="text-lg font-semibold">Chats</h1>
                <button id="closeSidebarBtn" class="lg:hidden p-1 hover:bg-gray-800 rounded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- New Chat Button -->
            <button id="newChatBtn" class="m-4 w-auto px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium flex items-center gap-2 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                <span>New Chat</span>
            </button>

            <!-- Chat List -->
            <div id="chatList" class="flex-1 overflow-y-auto px-2">
                <!-- Chat items will be added here -->
            </div>

            <div class="px-4 py-2 text-xs text-gray-500">v0.1.0</div>
        </aside>

        <!-- Context Menu -->
        <div id="contextMenu" class="context-menu hidden">
            <div id="renameOption" class="context-menu-item text-sm">
                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Rename
            </div>
            <div id="deleteOption" class="context-menu-item danger text-sm">
                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Delete
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col bg-white">
            <!-- Header -->
            <header class="border-b border-gray-200 px-4 py-3 flex items-center gap-4">
                <button id="toggleSidebarBtn" class="lg:hidden p-2 hover:bg-gray-100 rounded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <h2 id="chatTitle" class="text-lg font-semibold text-gray-800 flex-1">New Chat</h2>
                <button id="settingsBtn" class="p-2 hover:bg-gray-100 rounded" title="Settings">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
            </header>

            <!-- Messages Area -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="flex justify-center">
                    <div class="text-gray-400 text-center">
                        <p class="text-lg font-medium">Hey! Just say something and let's chat ðŸ˜Š</p>
                    </div>
                </div>
            </div>

            <!-- Rewrite Suggestion (hidden by default) -->
            <div id="rewriteSuggestion" class="hidden mx-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-gray-700 mb-2">Maybe try saying it like this:</p>
                <p id="rewriteText" class="text-blue-600 text-sm mb-3"></p>
                <div class="flex gap-2">
                    <button id="acceptRewriteBtn" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition">Accept</button>
                    <button id="rejectRewriteBtn" class="px-3 py-1 bg-gray-300 text-gray-700 text-sm rounded hover:bg-gray-400 transition">Reject</button>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-200 p-4 bg-white">
                <div class="flex gap-2">
                    <textarea id="messageInput" class="flex-1 p-3 border border-gray-200 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Say something..."></textarea>
                    <div class="flex flex-col gap-2">
                        <button id="rewriteBtn" class="p-3 bg-gray-200 hover:bg-gray-300 rounded-lg transition flex items-center justify-center" title="Rewrite">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span class="hidden lg:inline ml-2">Rewrite</span>
                        </button>
                        <button id="sendBtn" class="p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition flex items-center justify-center" title="Send">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                            <span class="hidden lg:inline ml-2">Send</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold mb-4">Settings</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Gemini API Key</label>
                    <input type="password" id="apiKeyInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your Gemini API key">
                    <p class="text-xs text-gray-500 mt-1">Get your API key from <a href="https://aistudio.google.com/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a></p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button id="saveSettingsBtn" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Save</button>
                <button id="cancelSettingsBtn" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div id="renameModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold mb-4">Rename Chat</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Chat Name</label>
                    <input type="text" id="renameInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter chat name">
                    <button id="generateNameBtn" class="mt-2 text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <span id="generateNameText">Generate AI name from conversation</span>
                    </button>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button id="saveRenameBtn" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Save</button>
                <button id="cancelRenameBtn" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let chats = [];
        let currentChatId = null;
        let contextMenuChatId = null;
        let apiKey = localStorage.getItem('randomchat_api_key') || '';

        // DOM Elements
        const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
        const closeSidebarBtn = document.getElementById('closeSidebarBtn');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const sidebar = document.getElementById('sidebar');
        const newChatBtn = document.getElementById('newChatBtn');
        const chatList = document.getElementById('chatList');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const rewriteBtn = document.getElementById('rewriteBtn');
        const chatTitle = document.getElementById('chatTitle');
        const rewriteSuggestion = document.getElementById('rewriteSuggestion');
        const acceptRewriteBtn = document.getElementById('acceptRewriteBtn');
        const rejectRewriteBtn = document.getElementById('rejectRewriteBtn');
        const contextMenu = document.getElementById('contextMenu');
        const renameOption = document.getElementById('renameOption');
        const deleteOption = document.getElementById('deleteOption');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
        const renameModal = document.getElementById('renameModal');
        const renameInput = document.getElementById('renameInput');
        const saveRenameBtn = document.getElementById('saveRenameBtn');
        const cancelRenameBtn = document.getElementById('cancelRenameBtn');
        const generateNameBtn = document.getElementById('generateNameBtn');
        const generateNameText = document.getElementById('generateNameText');

        // System instruction for chat buddy persona
        const BUDDY_SYSTEM_INSTRUCTION = `You are a chill chat buddy helping someone practice English.
Talk like a real friend â€” casual, short replies, use slang sometimes.
Don't act like an AI assistant. No formal language. No bullet points or lists.
If they make grammar mistakes, don't correct them unless they ask.
Keep responses to 1-3 sentences max.
Ask follow-up questions to keep the conversation going.
Use lowercase sometimes, like real texting. It's ok to use "lol", "nah", "tbh", "gonna", etc.`;

        // API Functions
        async function callGeminiAPI(messages) {
            if (!apiKey) {
                throw new Error('Please set your API key in settings');
            }

            const model = 'gemini-2.5-flash-lite';
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            // Convert chat messages to Gemini multi-turn format
            const contents = messages.map(msg => ({
                role: msg.role === 'assistant' ? 'model' : 'user',
                parts: [{ text: msg.content }]
            }));

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    systemInstruction: {
                        parts: [{ text: BUDDY_SYSTEM_INSTRUCTION }]
                    },
                    contents,
                    generationConfig: {
                        temperature: 0.9
                    }
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'API request failed');
            }

            const data = await response.json();
            if (data.candidates && data.candidates.length > 0 && data.candidates[0].content) {
                return data.candidates[0].content.parts[0].text;
            } else {
                throw new Error('No content generated');
            }
        }

        // Toggle Sidebar
        toggleSidebarBtn.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        });

        closeSidebarBtn.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        });

        // Settings Modal
        settingsBtn.addEventListener('click', () => {
            apiKeyInput.value = apiKey;
            settingsModal.classList.remove('hidden');
        });

        cancelSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        saveSettingsBtn.addEventListener('click', () => {
            apiKey = apiKeyInput.value.trim();
            localStorage.setItem('randomchat_api_key', apiKey);
            settingsModal.classList.add('hidden');
        });

        // Rename Modal
        let renamingChatId = null;

        cancelRenameBtn.addEventListener('click', () => {
            renameModal.classList.add('hidden');
            renamingChatId = null;
        });

        saveRenameBtn.addEventListener('click', () => {
            if (renamingChatId && renameInput.value.trim()) {
                const chat = chats.find(c => c.id === renamingChatId);
                if (chat) {
                    chat.title = renameInput.value.trim();
                    if (currentChatId === renamingChatId) {
                        chatTitle.textContent = chat.title;
                    }
                    renderChatList();
                    saveChats();
                }
            }
            renameModal.classList.add('hidden');
            renamingChatId = null;
        });

        renameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveRenameBtn.click();
            } else if (e.key === 'Escape') {
                cancelRenameBtn.click();
            }
        });

        generateNameBtn.addEventListener('click', async () => {
            if (!apiKey) {
                alert('Please set your Gemini API key in settings first!');
                return;
            }

            if (!renamingChatId) return;

            const chat = chats.find(c => c.id === renamingChatId);
            if (!chat || chat.messages.length === 0) {
                alert('No conversation to analyze. Please send some messages first.');
                return;
            }

            // Show loading state
            const originalText = generateNameText.textContent;
            generateNameText.textContent = 'Generating...';
            generateNameBtn.disabled = true;

            try {
                // Create a prompt for generating a chat name
                const conversationSummary = chat.messages
                    .filter(m => !m.typing)
                    .slice(0, 10) // Take first 10 messages
                    .map(m => `${m.role}: ${m.content}`)
                    .join('\n');

                const prompt = `Based on this conversation, suggest a short, descriptive chat name (2-5 words maximum). Only respond with the name itself, nothing else:\n\n${conversationSummary}`;

                const model = 'gemini-2.5-flash-lite';
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 20
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate name');
                }

                const data = await response.json();
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content) {
                    const suggestedName = data.candidates[0].content.parts[0].text.trim();
                    renameInput.value = suggestedName;
                    renameInput.select();
                }
            } catch (error) {
                console.error('Name generation error:', error);
                alert('Failed to generate name. Please try again.');
            } finally {
                generateNameText.textContent = originalText;
                generateNameBtn.disabled = false;
            }
        });

        // Close modals when clicking outside
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.add('hidden');
            }
        });

        renameModal.addEventListener('click', (e) => {
            if (e.target === renameModal) {
                cancelRenameBtn.click();
            }
        });

        // Local Storage Functions
        function saveChats() {
            const nonEmptyChats = chats.filter(chat => chat.messages.length > 0);
            localStorage.setItem('randomChats', JSON.stringify(nonEmptyChats));
            localStorage.setItem('currentChatId', currentChatId);
        }

        function loadChats() {
            const savedChats = localStorage.getItem('randomChats');
            const savedChatId = localStorage.getItem('currentChatId');
            if (savedChats) {
                chats = JSON.parse(savedChats);
                currentChatId = savedChatId ? parseInt(savedChatId) : null;
                if (currentChatId && chats.find(c => c.id === currentChatId)) {
                    selectChat(currentChatId);
                }
                renderChatList();
            }
        }

        // New Chat
        newChatBtn.addEventListener('click', createNewChat);

        function createNewChat() {
            const chatId = Date.now();
            const now = new Date(chatId);
            const title = now.getFullYear() + '-' +
                         String(now.getMonth() + 1).padStart(2, '0') + '-' +
                         String(now.getDate()).padStart(2, '0') + ' ' +
                         String(now.getHours()).padStart(2, '0') + ':' +
                         String(now.getMinutes()).padStart(2, '0') + ':' +
                         String(now.getSeconds()).padStart(2, '0');
            const chat = { id: chatId, title: title, messages: [] };
            chats.push(chat);
            selectChat(chatId);
            renderChatList();
            saveChats();
            closeSidebarOnMobile();
        }

        function selectChat(chatId) {
            currentChatId = chatId;
            renderMessages();
            const chat = chats.find(c => c.id === chatId);
            chatTitle.textContent = chat?.title || 'New Chat';
            saveChats();
        }

        function renderChatList() {
            const sortedChats = [...chats].sort((a, b) => b.id - a.id);
            chatList.innerHTML = sortedChats.map(chat => `
                <div class="chat-item p-3 m-2 bg-gray-800 hover:bg-gray-700 rounded-lg cursor-pointer transition ${chat.id === currentChatId ? 'bg-gray-700 border-l-4 border-blue-600' : ''}" data-chat-id="${chat.id}">
                    <p class="text-sm truncate">${chat.title}</p>
                </div>
            `).join('');

            document.querySelectorAll('.chat-item').forEach(item => {
                item.addEventListener('click', () => {
                    hideContextMenu();
                    selectChat(parseInt(item.dataset.chatId));
                });
                item.addEventListener('dblclick', () => {
                    renameChat(parseInt(item.dataset.chatId));
                });
                item.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showContextMenu(e.pageX, e.pageY, parseInt(item.dataset.chatId));
                });
            });
        }

        function deleteChat(chatId) {
            chats = chats.filter(c => c.id !== chatId);
            if (currentChatId === chatId) {
                currentChatId = chats.length > 0 ? chats[0].id : null;
                if (currentChatId) selectChat(currentChatId);
                else saveChats();
            }
            renderChatList();
            saveChats();
        }

        function renameChat(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;

            renamingChatId = chatId;
            renameInput.value = chat.title;
            renameModal.classList.remove('hidden');
            setTimeout(() => renameInput.select(), 100);
        }

        function showContextMenu(x, y, chatId) {
            contextMenuChatId = chatId;
            contextMenu.style.left = `${x}px`;
            contextMenu.style.top = `${y}px`;
            contextMenu.classList.remove('hidden');
        }

        function hideContextMenu() {
            contextMenu.classList.add('hidden');
            contextMenuChatId = null;
        }

        function renderMessages() {
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) {
                messagesContainer.innerHTML = '<div class="flex justify-center"><div class="text-gray-400 text-center"><p class="text-lg font-medium">Hey! Just say something and let\'s chat</p></div></div>';
                return;
            }

            messagesContainer.innerHTML = chat.messages.map(msg => {
                if (msg.typing) {
                    return `
                        <div class="flex justify-start">
                            <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg bg-gray-100 text-gray-900">
                                <div class="typing-indicator flex gap-1">
                                    <span class="w-2 h-2 bg-gray-500 rounded-full"></span>
                                    <span class="w-2 h-2 bg-gray-500 rounded-full"></span>
                                    <span class="w-2 h-2 bg-gray-500 rounded-full"></span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                return `
                    <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${msg.role === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-900'}">
                            <p class="text-sm whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                        </div>
                    </div>
                `;
            }).join('');

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Send Message
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !currentChatId) return;

            // Check if API key is set
            if (!apiKey) {
                alert('Please set your Gemini API key in settings first!');
                settingsModal.classList.remove('hidden');
                apiKeyInput.focus();
                return;
            }

            if (!chats.find(c => c.id === currentChatId)) return;

            const chat = chats.find(c => c.id === currentChatId);
            chat.messages.push({ role: 'user', content });
            messageInput.value = '';
            renderMessages();
            rewriteSuggestion.classList.add('hidden');
            saveChats();

            // Disable send button while processing
            sendBtn.disabled = true;
            messageInput.disabled = true;

            // Show typing indicator
            const typingId = Date.now();
            chat.messages.push({ role: 'assistant', content: '...', typing: true, id: typingId });
            renderMessages();

            try {
                // Call Gemini API
                const response = await callGeminiAPI(chat.messages.filter(m => !m.typing));

                // Remove typing indicator and add real response
                chat.messages = chat.messages.filter(m => m.id !== typingId);
                chat.messages.push({ role: 'assistant', content: response });
                renderMessages();
                saveChats();
            } catch (error) {
                console.error('API Error:', error);
                chat.messages = chat.messages.filter(m => m.id !== typingId);
                chat.messages.push({ role: 'assistant', content: `Error: ${error.message}` });
                renderMessages();
                saveChats();
            } finally {
                // Re-enable send button
                sendBtn.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }

        // Rewrite Feature - grammar correction via API
        let lastRewriteResult = '';

        rewriteBtn.addEventListener('click', async () => {
            const content = messageInput.value.trim();
            if (!content) return;

            if (!apiKey) {
                alert('Please set your Gemini API key in settings first!');
                return;
            }

            rewriteBtn.disabled = true;

            try {
                const model = 'gemini-2.5-flash-lite';
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        systemInstruction: {
                            parts: [{ text: 'You are an English grammar helper. Fix any grammar, spelling, or phrasing errors in the user\'s message. Keep the same casual tone and meaning. Only output the corrected sentence, nothing else. If the message is already correct, output it unchanged.' }]
                        },
                        contents: [{ role: 'user', parts: [{ text: content }] }],
                        generationConfig: { temperature: 0.3 }
                    })
                });

                if (!response.ok) throw new Error('API request failed');

                const data = await response.json();
                if (data.candidates?.[0]?.content) {
                    lastRewriteResult = data.candidates[0].content.parts[0].text.trim();
                    document.getElementById('rewriteText').textContent = lastRewriteResult;
                    rewriteSuggestion.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Rewrite error:', error);
                alert('Failed to rewrite. Please try again.');
            } finally {
                rewriteBtn.disabled = false;
            }
        });

        acceptRewriteBtn.addEventListener('click', () => {
            if (lastRewriteResult) {
                messageInput.value = lastRewriteResult;
            }
            rewriteSuggestion.classList.add('hidden');
        });

        rejectRewriteBtn.addEventListener('click', () => {
            rewriteSuggestion.classList.add('hidden');
        });

        // Context Menu
        renameOption.addEventListener('click', () => {
            if (contextMenuChatId) {
                renameChat(contextMenuChatId);
                hideContextMenu();
            }
        });

        deleteOption.addEventListener('click', () => {
            if (contextMenuChatId) {
                deleteChat(contextMenuChatId);
                hideContextMenu();
            }
        });

        // Hide context menu when clicking elsewhere
        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target)) {
                hideContextMenu();
            }
        });

        function closeSidebarOnMobile() {
            if (window.innerWidth < 1024) {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            }
        }

        // Initialize
        loadChats();
        if (chats.length === 0) {
            createNewChat();
        }
    </script>
</body>
</html>